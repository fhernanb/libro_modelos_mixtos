# Intervalos de confianza {#IC}

En este capítulo vamos mostrar como se pueden obtener intervalos de confianza para los parámetros del modelo e intervalos de confianza para predicción.

## Intervalos de confianza para los parámetros

En esta sección se mostrará cómo utilizar la función `confint()` para obtener intervalos de confianza para los elementos del vector de parámetros $\boldsymbol{\Theta}$ de un modelo lineal generalizado mixto.

## Ejemplo: modelo normal {-}

En este ejemplo su usará la base de datos `sleepstudy` del paquete **lme4** de @R-lme4 sobre el tiempo de reacción promedio por día para un conjunto de individuos en un estudio de privación del sueño. La base de datos contiene la información sobre el tiempo de reacción promedio (`Reaction`), el número de días de privación del sueño (`Days`), donde el día 0 corresponde al día en el que los individuos tenían su cantidad normal de sueño, y el número del individuo (en total 18) sobre el que se realizó la observación (`Subject`). A partir del día 0, hubo una restricción en cada individuo a 3 horas de sueño por noche.

```{r echo=FALSE, out.width="40%", fig.align='center'}
knitr::include_graphics("images/sleep_study.png")
```

El objetivo es ajustar el siguiente modelo a los datos.

\begin{align*} 
Reaction_{ij} | b_0, b_1 &\sim  N(\mu_{ij}, \sigma^2_{Reaction}) \\ 
\mu_{ij} &= \beta_0 + \beta_1 Days_{ij} + b_{0i} + b_{1i} Days_{ij} \\
\left (
\begin{matrix}
b_{0} \\ b_{1}
\end{matrix} 
\right ) &\sim 
N\left ( \left [ \begin{matrix}
0 \\ 0
\end{matrix} \right ],
\left [ \begin{matrix}
\sigma^2_{b0} & \sigma_{b01} \\ 
\sigma_{b01} & \sigma^2_{b1}
\end{matrix} \right ]
\right )
\end{align*}

Lo primero que debemos hacer es ajustar el modelo usando el siguiente código.

```{r}
library(lme4)
head(sleepstudy)
fit <- lmer(Reaction ~ Days + (Days | Subject), REML = TRUE, data = sleepstudy)
```

La tabla de resultados del modelo ajustado se muestra a continuación.

```{r}
summary(fit)
```

De la tabla anterior podemos ver que las estimaciones del vector de parámetros es

$$
\hat{\boldsymbol{\Theta}} = (\hat{\beta_0}=251.40, \hat{\beta_1}=10.47, \hat{\sigma}_{reaction}=25.59, \hat{\sigma}_{b0}=24.74, \hat{\sigma}_{b1}=5.92, \hat{\rho}_{b0b1}=0.07)^\top
$$

Para obtener los intervalos de confianza podemos usar la función `confint()`.

```{r}
#### Calculate Wald CIs (Fastest Version) ####
ci.wald <- confint(fit, level=0.95)
ci.wald
```

También es posible obtener los intervalos de confianza por el método boostrap así.

```{r}
#### Calculate Bootstrapped CIs ####
ci.boot <- confint(fit, method = "boot", nsim = 1000)
ci.boot
```

## Ejemplo: modelo gamma {-}

En este ejemplo analizamos los datos de semiconductores tomados de Myers et al. (2002) sobre un experimento diseñado en una planta de semiconductores. Se emplean seis factores, temperatura de laminación, tiempo de laminación, presión de laminación, temperatura de cocción, tiempo de ciclo de cocción y punto de rocío de cocción, y estamos interesados en la curvatura de los dispositivos de sustrato producidos en la planta. La medición de la curvatura se realiza cuatro veces en cada dispositivo fabricado. Cada variable de diseño se toma en dos niveles. Se sabe que la medida no tiene una distribución normal y las medidas tomadas en el mismo dispositivo están correlacionadas.

Las variables de la base de datos se muestran a continuación.

- Device: Subtrate device
- x1: Lamination Temperature; two levels +1 and -1.
- x2: Lamination Time; two levels: +1 and -1.
- x3: Lamination Presure; two levels: +1 and -1.
- x4: Firing Temperature; two levels: +1 and -1.
- x5: Firing Cycle Time; two levels: +1 and -1.
- x6: Firing Dew Point: two levels: +1 and -1.
- y: Camber measure; in 1e-4 in./in.

```{r echo=FALSE, out.width="50%", fig.align='center', fig.align='center', fig.alt='Tomada de https://www.iqsdirectory.com/'}
knitr::include_graphics("images/semiconductors.jpg")
```

El objetivo es ajustar el siguiente modelo a los datos.

\begin{align*} 
y_{ij} | b_0 &\sim  Gamma(\mu_{ij}, \phi) \\ 
\log(\mu_{ij}) &= \beta_0 + \beta_1 x1_{ij} + \beta_3 x3_{ij} + \beta_5 x5_{ij} + \beta_6 x6_{ij} + b_{0i} \\
b_{0} &\sim N(0, \sigma^2_{b0})
\end{align*}

Para ajustar el modelo anterior usamos el siguiente código.

```{r message=FALSE}
library(hglm)
data(semiconductor)

library(glmmTMB)
fit <- glmmTMB(y ~ x1 + x3 + x5 + x6 + (1 | Device), 
               data = semiconductor,
               family = Gamma(link = log))

summary(fit)
```


De la tabla anterior podemos ver que las estimaciones del vector de parámetros es

$$
\hat{\boldsymbol{\Theta}} = (\hat{\beta_0}=-4.71, \hat{\beta_1}=0.18, \hat{\beta_3}=0.31, \hat{\beta_5}=-0.19, \hat{\beta_6}=-0.37, \hat{\phi}=0.31, \hat{\sigma}_{b0}=0.17)^\top
$$

Para obtener los intervalos de confianza usamos las siguientes instrucciones.

```{r eval=FALSE}
FUN <- function(model=fit) {
  temp_mod <- refit(fit, simulate(fit)[[1]])
  result <- c(as.numeric(temp_mod$fit$par[1:7]),
              temp_mod$obj$report()$sd[[1]])
  return(result)
}

b1 <- lme4::bootMer(fit, FUN, nsim=100, .progress="txt")
```

Para imprimir los intervalos de confianza de los 8 parámetros hacemos lo siguiente:

```{r eval=FALSE}
library(boot)

cat("95% Bootstrap confidence intervals for glmmTMB\n")

for (i in 1:8) {
  print(boot.ci(b1, type="perc", index=i)[4]$percent[4:5])
}
```

## Intervalos de confianza para predicción

En esta sección se mostrará cómo utilizar el paquete **ggeffects** de @R-ggeffects para obtener intervalos de confianza para predicciones de un modelo lineal generalizado mixto.

## Ejemplo: modelo normal {-}

En este ejemplo vamos a retomar los datos `sleepstudy` del paquete **lme4** de @R-lme4 sobre el tiempo de reacción promedio por día para un conjunto de individuos en un estudio de privación del sueño. La base de datos contiene la información sobre el tiempo de reacción promedio (`Reaction`), el número de días de privación del sueño (`Days`), donde el día 0 corresponde al día en el que los individuos tenían su cantidad normal de sueño, y el número del individuo (en total 18) sobre el que se realizó la observación (`Subject`). A partir del día 0, hubo una restricción en cada individuo a 3 horas de sueño por noche.

```{r echo=FALSE, out.width="40%", fig.align='center'}
knitr::include_graphics("images/sleep_study.png")
```

Vamos a mostrar gráficamente los datos.

```{r plot_curves_sleep}
library(ggplot2)

ggplot(data = sleepstudy, aes(x = Days, y = Reaction, color = Subject)) +
  geom_point() +
  theme_bw() +
  facet_wrap(~ Subject) + labs(y = "Reaction time") + 
  theme(legend.position = "none")
```

Ahora vamos a ajustar el modelo de interés.

```{r}
library(ggeffects)
library(lme4)
data(sleepstudy)

fit <- lmer(Reaction ~ Days + (1 + Days | Subject), data = sleepstudy)
```

### Predicción para cada individuo {-}

Ahora supongamos que nos interesa predecir el tiempo de reacción de los pacientes 335 y 337 en los días de observación 1, 5 y 9, y en los días 12, 15 que no fueron aún observados. Adicionalmente queremos los intervalos de confianza del 95% para la predicción en esos mismos días. Para eso vamos a usar la función `predict_response()` de la siguiente manera:

```{r}
pre1 <- predict_response(model=fit,
                         ci_level=0.95, 
                         terms=c("Days [1, 5, 9, 12, 15]", 
                                 "Subject [335, 337]"), 
                         type="random")
pre1
```

Como resultado se obtienen dos tablas, una para el paciente 335 y otra para el paciente 337. Cada tabla muestra los días, la predicción del tiempo de reacción promedio $\mu$ y los intervalos de confianza del 95%.

Es posible representar gráficamente la predicción y los intervalos usando la función genérica `plot()` sobre el objeto `pre1` así:

```{r plot_ic_pred_sleep_01}
plot(pre1, show_data = TRUE, show_ci = TRUE)
```

En la figura anterior se observan los modelos ajustados representados por las líneas continuas y los intervalos como sombras. Adicionalmente se observan unos puntos que corresponden a los datos originales para los pacientes considerados. 

La figura anterior puede ser usada para monitorear la variable respuesta en los días 10, 11, 12 y siguientes. Los intervalos de confianza se hacen más anchos a medida que el número de días aumenta, esto es esperado ya que si queremos hacer una estimación lejos del día 9, muy seguramente tendremos más incertidumbre que para días cercanos al 9.

### Predicciones condicionales {-}

Las predicciones condicionales son predicciones para el parámetro $\mu$ de la variable respuesta pensando en un paciente (o grupo) "típico", es decir, predicciones para $\mu$ sin incluir los efectos aleatorios predichos en la ecuación. Para obtener esta predicción se usa la función `predict_response` con `margin="mean_reference"`.

Supongamos que nos interesa obtener predicciones condicionales con respecto a la variable días fijada en los valores de 1, 5, 9 y 12. El código para realizar esto es el siguiente:

```{r}
# conditional predictions
pre2 <- predict_response(model=fit, 
                         terms="Days [1, 5, 9, 12]",
                         margin="mean_reference")
pre2
```

Como resultado obtenemos una tabla con el valor predicho para $\mu$ en los días solicitados y los intervalos de confianza.

Es posible representar estos resultados gráficamente de la siguiente manera.

```{r plot_ic_pred_sleep_02}
plot(pre2, show_data = TRUE, show_ci = TRUE)
```

### Predicciones marginales {-}

Las predicciones marginales son predicciones para el parámetro $\mu$ de la variable respuesta pensando en el efecto de una covariable $X$ sobre todos los pacientes (o grupos) de forma general. 

```{r}
# average marginal predictions
pre3 <- predict_response(model=fit, 
                         terms="Days [1, 5, 9]", 
                         margin="empirical")
pre3
```

Como resultado obtenemos una tabla con el valor predicho para $\mu$ en los días solicitados y los intervalos de confianza.

Es posible representar estos resultados gráficamente de la siguiente manera.

```{r plot_ic_pred_sleep_03}
plot(pre3, show_data = TRUE, show_ci = TRUE)
```

<div style="-moz-box-shadow: 1px 1px 3px 2px #ffff00;
  -webkit-box-shadow: 1px 1px 3px 2px #ffff00;
  box-shadow:         1px 1px 3px 2px #ffff00;">
```{block2, type='rmdnote'}
Cuando el conjunto de datos usados para ajustar el modelo tiene la misma cantidad de observaciones para cada grupo, las predicciones condicionales y marginales son muy similares. Pero cuando los grupos son desbalanceados, estas estimaciones difieren. Una explicación detallada de esta situación y un ejemplo puede consultarse en https://strengejacke.github.io/ggeffects/articles/introduction_randomeffects.html
```
</div>


Ver https://www.andrewheiss.com/blog/2022/11/29/conditional-marginal-marginaleffects/
